#!/bin/sh

help() {
  cat <<-EOF
TODO
EOF
}

if [[ -z "$1" ]]; then
  help
  exit 0
fi

id="$1"
shift

IFS=',' read -a cmds <<< $(grep -e "^$id" "$DOTFILES/lib/layouts")

if [[ -z "$cmds" ]]; then
  echo "No layout called $id"
  exit 1
fi

dir="${cmds[1]}"
if [[ "$dir" == "." ]]; then
  dir="$PWD"
fi
session="$(tmux display-message -p '#S')"

tmux new-window -n "$id" -c "$dir" -d

pane=1
for value in "${cmds[@]:2}"; do
  target="$session:$id.$pane"
  case "$value" in
    v)
      tmux split-window -t "$target" -v -c "$dir" -d
      ((pane++))
      ;;
    h)
      tmux split-window -t "$target" -h -c "$dir" -d
      ((pane++))
      ;;
    *)
      tmux send-keys -t "$target" "$value" ENTER
      ;;
  esac
done

if [[ "$1" == "-a" ]]; then
  tmux select-window -t "$session:$id"
fi

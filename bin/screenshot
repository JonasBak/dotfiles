#!/bin/bash
export FZF="$HOME/.fzf/bin/fzf --reverse"
# TODO
export WL_CLIPBOARD_DIR=$HOME/code/packages/bin
export GRIM_DIR=$HOME/code/packages/bin


RESP=$(cat <<EOF | $FZF
screen
window
EOF
);

case "$RESP" in
  screen)
    VALUE="$(swaymsg -t get_outputs | jq -r '.[] | "\(.name)"' | $FZF)"
    if [[ -z "$VALUE" ]]; then
      exit 1
    fi
    FLAG="-o"
    ;;
  window)
    VALUE="$(swaymsg -t get_tree |\
      jq -r '.. | select(.pid? and .visible?) | "\(.rect.x),\(.rect.y) \(.rect.width)x\(.rect.height) (\(.name))"' |\
      grep -v "screenshot" | $FZF | cut -d ' ' -f 1,2 --output-delimiter ' ')"
    if [[ -z "$VALUE" ]]; then
      exit 1
    fi
    FLAG="-g"
    ;;
  *)
    exit 1
esac


RESP=$(cat <<EOF | $FZF
save
copy
EOF
);

case "$RESP" in
  save)
    echo "Filename:"
    read FILENAME </dev/tty
    if [[ -z "$FILENAME" ]]; then
      exit 1
    fi
    $GRIM_DIR/grim $FLAG "$VALUE" ~/Pictures/$FILENAME
    ;;
  copy)
    echo "Copied image!"
    echo
    echo "Window will close and clipboard will clear after pasted"
    $GRIM_DIR/grim $FLAG "$VALUE" - | $WL_CLIPBOARD_DIR/wl-copy -fo
    ;;
  *)
    exit 1
esac
